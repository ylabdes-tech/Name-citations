name: Build Android APK
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ANDROID_HOME: /home/runner/android-sdk
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64
      LD_LIBRARY_PATH: /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server:/usr/lib
      PATH: /bin:/usr/bin:/usr/local/bin:/home/runner/.local/bin:$PATH:/home/runner/android-sdk/cmdline-tools/latest/bin:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/build-tools/30.0.3
    steps:
      - name: Clean apt locks
        run: |
          echo "Nettoyage des verrous apt..."
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -f /var/cache/apt/*.bin
          sudo rm -rf /var/lib/apt/lists/*
      - name: Ajouter le PPA deadsnakes pour Python 3.8 et 3.9
        run: |
          echo "Ajout du PPA deadsnakes..."
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update
      - name: Installer les dépendances système
        run: |
          echo "Installation des dépendances système..."
          sudo apt-get install -y \
            git tar build-essential \
            python3-dev python3.9 python3.9-dev python3.9-venv python3.9-distutils \
            python3.8 python3.8-dev python3.8-venv python3.8-distutils python3-pip \
            ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            openjdk-8-jdk openjdk-8-jre unzip zlib1g-dev libffi-dev libssl-dev \
            gcc g++ libc6-dev libstdc++6 libjpeg-dev libpng-dev
      - name: Vérifier les installations Python
        run: |
          echo "Vérification de Python 3.9 :"
          python3.9 --version || { echo "Échec de l'installation de Python 3.9"; exit 1; }
          echo "Vérification de Python 3.8 :"
          python3.8 --version || { echo "Échec de l'installation de Python 3.8"; exit 1; }
      - name: Checkout du dépôt
        uses: actions/checkout@v4
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Créer et activer un environnement virtuel pour Python 3.9
        run: |
          echo "Création de l'environnement virtuel pour Python 3.9..."
          python3.9 -m venv /home/runner/venv
          source /home/runner/venv/bin/activate
          echo "Mise à jour de pip..."
          python -m pip install --upgrade pip
      - name: Installer les dépendances Python
        run: |
          source /home/runner/venv/bin/activate
          echo "Installation des dépendances Python..."
          python -m pip install cython==0.29.36 buildozer kivy==2.2.1 plyer pyjnius==1.4.0 --no-cache-dir
      - name: Fallback vers Python 3.8 si Python 3.9 échoue
        if: failure()
        run: |
          echo "Échec de Python 3.9, tentative avec Python 3.8..."
          if ! command -v python3.8 &> /dev/null; then
            echo "python3.8 n'est pas installé"
            exit 1
          fi
          python3.8 -m venv /home/runner/venv3.8
          source /home/runner/venv3.8/bin/activate
          python -m pip install --upgrade pip
          python -m pip install cython==0.29.36 buildozer kivy==2.2.1 plyer pyjnius==1.4.0 --no-cache-dir
      - name: Installer le SDK Android
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME "build-tools;30.0.3" "platforms;android-30" "platform-tools"
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME --licenses
      - name: Construire l'APK
        run: |
          source /home/runner/venv/bin/activate
          buildozer android debug
      - name: Téléverser l'APK
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: bin/*.apk
