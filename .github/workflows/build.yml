- name: Setup Python venv & install dependencies with pyjnius patch
  shell: bash
  run: |
    python3.10 -m venv /home/runner/venv
    source /home/runner/venv/bin/activate

    pip install --upgrade pip setuptools wheel cython==0.29.36

    export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    export LD_LIBRARY_PATH=$JAVA_HOME/lib/server:$JAVA_HOME/lib:$JAVA_HOME/jre/lib/amd64/server:$JAVA_HOME/jre/lib/amd64
    export CFLAGS="-I$JAVA_HOME/include -I$JAVA_HOME/include/linux"
    export LDFLAGS="-L$JAVA_HOME/lib/server -L$JAVA_HOME/lib -ljvm"
    export JNIUS_PLATFORM=android

    pip install buildozer kivy==2.2.1 plyer --no-cache-dir

    # Tentative d’installation pyjnius avec options de build spécifiques
    pip install --no-binary pyjnius --no-cache-dir --global-option=build_ext --global-option="-I$JAVA_HOME/include" --global-option="-I$JAVA_HOME/include/linux" pyjnius==1.6.1 || {
      # En cas d’échec, clonage et patch manuel
      git clone --depth=1 https://github.com/kivy/pyjnius.git
      cd pyjnius
      sed -i "/ext_modules = cythonize(/i \
      define_macros=[('JNIUS_PLATFORM','\"android\"'), ('JNIUS_PYTHON3', '1')]," setup.py
      pip install .
      cd ..
    }

    python -c "import kivy; print('Kivy version:', kivy.__version__)"
    python -c "import pyjnius; print('Pyjnius imported successfully')"
    python -c "import plyer; print('Plyer imported successfully')"
