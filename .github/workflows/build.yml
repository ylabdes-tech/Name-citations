name: Build Android APK
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ANDROID_HOME: /home/runner/android-sdk
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64
      LD_LIBRARY_PATH: /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server:/usr/lib
      LD_PRELOAD: /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server/libjvm.so
      CFLAGS: -I/usr/lib/jvm/java-8-openjdk-amd64/include -I/usr/lib/jvm/java-8-openjdk-amd64/include/linux
      LDFLAGS: -L/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64 -L/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server -ljvm
      PATH: /home/runner/venv/bin:/bin:/usr/bin:/usr/local/bin:/home/runner/android-sdk/cmdline-tools/latest/bin:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/build-tools/30.0.3
    steps:
      - name: Clean apt locks and Java installations
        run: |
          echo "Nettoyage des verrous apt et des installations Java..."
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -f /var/cache/apt/*.bin
          sudo rm -rf /var/lib/apt/lists/*
          sudo update-java-alternatives -s java-1.8.0-openjdk-amd64 || echo "Échec de la mise à jour des alternatives Java, poursuite..."
          sudo apt-get purge -y openjdk* || echo "Aucune installation Java à purger"
          sudo apt-get autoremove -y
          sudo apt-get autoclean
      - name: Ajouter le PPA deadsnakes pour Python 3.9
        run: |
          echo "Ajout du PPA deadsnakes..."
          for i in {1..10}; do
            sudo apt-get update && \
            sudo apt-get install -y software-properties-common && \
            sudo add-apt-repository ppa:deadsnakes/ppa -y && \
            sudo apt-get update && break || \
            echo "Tentative $i échouée, nouvelle tentative..."; sleep 20
          done
          echo "Vérification des paquets Python disponibles :"
          sudo apt-cache search python3.9 || echo "Échec de la recherche des paquets python3.9"
          sudo apt-cache policy python3.9 || echo "Échec de la vérification de la politique python3.9"
      - name: Installer les dépendances système
        run: |
          echo "Installation des dépendances système..."
          sudo apt-get install -y \
            git tar build-essential \
            python3-dev python3.9 python3.9-dev python3.9-venv python3.9-distutils python3-pip \
            ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            openjdk-8-jdk openjdk-8-jre unzip zlib1g-dev libffi-dev libssl-dev \
            gcc g++ libc6-dev libstdc++6 libjpeg-dev libpng-dev
          echo "Vérification des bibliothèques JNI :"
          find /usr/lib/jvm/java-8-openjdk-amd64 -name 'libjvm.so' || { echo "libjvm.so introuvable"; exit 1; }
          find /usr/lib -name 'libffi.so' || { echo "libffi.so introuvable"; exit 1; }
          find /usr/lib/jvm/java-8-openjdk-amd64/include -name 'jni.h' || { echo "jni.h introuvable"; exit 1; }
          echo "Vérification de LD_LIBRARY_PATH :"
          echo $LD_LIBRARY_PATH
          echo "Vérification de LD_PRELOAD :"
          echo $LD_PRELOAD
          echo "Vérification de libjvm.so :"
          ls -la /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server/libjvm.so || { echo "libjvm.so introuvable"; exit 1; }
      - name: Vérifier les installations Python et Java
        run: |
          echo "Vérification de Python 3.9 :"
          python3.9 --version || { echo "Échec de l'installation de Python 3.9"; exit 1; }
          python3.9 -m ensurepip --version || { echo "ensurepip introuvable pour Python 3.9"; exit 1; }
          echo "Vérification de Java :"
          echo "JAVA_HOME est défini à $JAVA_HOME"
          $JAVA_HOME/bin/java -version || { echo "Échec de l'installation de Java"; exit 1; }
          $JAVA_HOME/bin/javac -version || { echo "Échec de l'installation de javac"; exit 1; }
          echo "Vérification des en-têtes JNI :"
          ls -la /usr/lib/jvm/java-8-openjdk-amd64/include/jni.h || { echo "jni.h introuvable"; exit 1; }
      - name: Checkout du dépôt
        uses: actions/checkout@v4
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Nettoyer l'environnement Python
        run: |
          echo "Nettoyage de l'environnement Python utilisateur..."
          sudo rm -rf /home/runner/.local /home/runner/.kivy /home/runner/.cache/pip /home/runner/.cache /home/runner/venv
          unset PYTHONPATH
      - name: Créer et activer un environnement virtuel pour Python 3.9
        run: |
          echo "Création de l'environnement virtuel pour Python 3.9..."
          python3.9 -m venv /home/runner/venv --clear --without-pip
          source /home/runner/venv/bin/activate
          echo "Installation de pip manuellement..."
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          /home/runner/venv/bin/python get-pip.py pip==24.2
